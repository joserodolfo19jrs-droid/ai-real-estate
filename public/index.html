<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Real Estate</title>
  <style>
    :root { --b:#e8e8e8; --t:#111; --m:#666; --bg:#fafafa; }
    body { font-family: Arial, sans-serif; margin: 0; background: var(--bg); color: var(--t); }
    header { padding: 18px 16px; border-bottom: 1px solid var(--b); background:#fff; position: sticky; top: 0; z-index: 10; }
    header h1 { margin: 0; font-size: 18px; }
    header p { margin: 6px 0 0 0; color: var(--m); font-size: 12px; }
    main { max-width: 1100px; margin: 0 auto; padding: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 980px) { main { grid-template-columns: 1fr; } }
    .card { background:#fff; border:1px solid var(--b); border-radius:14px; padding:14px; }
    .card h2 { margin: 0 0 10px 0; font-size: 14px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 600px) { .row { grid-template-columns: 1fr; } }
    label { display:block; font-size:12px; color:var(--m); margin:10px 0 6px; }
    input, select, textarea { width:100%; box-sizing:border-box; padding:10px; border:1px solid var(--b); border-radius:10px; font-size:14px; background:#fff; }
    textarea { min-height: 90px; resize: vertical; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px; }
    button { border:1px solid var(--b); background:#111; color:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; font-size:14px; }
    button.secondary { background:#fff; color:#111; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .status { margin-top:10px; font-size:12px; color:var(--m); white-space: pre-wrap; }
    .error { color:#b00020; }
    .ok { color:#1b5e20; }
    .pill { display:inline-block; font-size:11px; padding:6px 10px; border:1px solid var(--b); border-radius:999px; background:#fff; }
    .result-title { margin: 10px 0 6px; font-size: 16px; font-weight: 800; }
    .result-meta { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
    .result-desc { white-space:pre-wrap; line-height:1.45; }
    .thumbs { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .thumb { width:140px; }
    .thumb img { width:140px; height:95px; object-fit:cover; border-radius:12px; border:1px solid var(--b); display:block; }
    .thumb button { width:100%; padding:7px 8px; margin-top:6px; font-size:12px; }
    .small { font-size:12px; color:var(--m); margin-top:8px; }
    a.link { color:#111; text-decoration:none; border-bottom: 1px dashed #bbb; }
    .hr { height:1px; background:var(--b); margin:12px 0; }
    .previewBar { display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <header>
    <h1>AI Real Estate</h1>
    <p>Generate listings, upload multiple photos, brand with agent info, and export PDFs.</p>
  </header>

  <main>
    <!-- LEFT -->
    <section class="card">
      <h2>Property Details</h2>

      <label for="tone">Tone</label>
      <select id="tone">
        <option>MLS (English)</option>
        <option>Luxury (English)</option>
        <option>Investor (English)</option>
        <option>Airbnb (English)</option>
        <option>MLS (Spanish)</option>
        <option>Luxury (Spanish)</option>
      </select>

      <div class="row">
        <div>
          <label for="address">Address</label>
          <input id="address" placeholder="123 Main St" />
        </div>
        <div>
          <label for="city">City</label>
          <input id="city" placeholder="Frisco" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="state">State</label>
          <input id="state" placeholder="TX" />
        </div>
        <div>
          <label for="price">Price</label>
          <input id="price" placeholder="550000" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="beds">Beds</label>
          <input id="beds" placeholder="4" />
        </div>
        <div>
          <label for="baths">Baths</label>
          <input id="baths" placeholder="3" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="sqft">Sqft</label>
          <input id="sqft" placeholder="2600" />
        </div>
        <div>
          <label for="yearBuilt">Year Built</label>
          <input id="yearBuilt" placeholder="2019" />
        </div>
      </div>

      <label for="features">Features / Notes</label>
      <textarea id="features" placeholder="Pool, updated kitchen, 3-car garage, etc."></textarea>

      <label for="descriptionInput">Extra Description From You</label>
      <textarea id="descriptionInput" placeholder="Any extra details you want the AI to emphasize..."></textarea>

      <div class="hr"></div>

      <h2>House Photos</h2>
      <label for="images">Select multiple photos (uploads to /api/uploads)</label>
      <input id="images" type="file" accept="image/*" multiple />

      <div class="previewBar">
        <button id="btnPreviewPhotos" type="button" class="secondary">Preview Photos</button>
        <span id="previewHint" class="small">Preview is hidden</span>
      </div>

      <div id="uploadStatus" class="status">No photos uploaded yet.</div>
      <div id="gallery" class="thumbs" style="display:none;"></div>

      <div class="hr"></div>

      <h2>Agent Branding (Optional)</h2>
      <div class="row">
        <div>
          <label for="agentName">Name</label>
          <input id="agentName" placeholder="Agent Name" />
        </div>
        <div>
          <label for="agentBrokerage">Brokerage</label>
          <input id="agentBrokerage" placeholder="Brokerage" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="agentPhone">Phone</label>
          <input id="agentPhone" placeholder="(555) 555-5555" />
        </div>
        <div>
          <label for="agentEmail">Email</label>
          <input id="agentEmail" placeholder="agent@email.com" />
        </div>
      </div>

      <label for="agentLogo">Agent Logo (single image)</label>
      <input id="agentLogo" type="file" accept="image/*" />
      <div id="logoStatus" class="status"></div>

      <div class="btns">
        <button id="btnGenerate" type="button">Generate</button>
        <button id="btnSave" type="button" class="secondary" disabled>Save</button>
        <button id="btnPdf" type="button" class="secondary" disabled>Download PDF</button>
      </div>

      <div id="mainStatus" class="status"></div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <h2>Result</h2>
      <div id="resultMeta" class="result-meta"></div>
      <div id="resultTitle" class="result-title">—</div>
      <div id="resultDesc" class="result-desc">Generate to see results.</div>
      <div id="shareBox" class="small"></div>
    </section>
  </main>

  <script>
    // ---------------- App state ----------------
  console.log("✅ NEW INDEX LOADED v1");
    let uploadedImageUrls = [];
    let uploadedLogoUrl = "";
    let currentListing = null;
    let previewOn = false;

    const $ = (id) => document.getElementById(id);

    function setStatus(el, msg, cls) {
      el.textContent = msg || "";
      el.className = "status" + (cls ? (" " + cls) : "");
    }

    function esc(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    // ---------------- Gallery UI ----------------
    function renderGallery() {
      const g = $("gallery");
      g.innerHTML = "";

      if (!uploadedImageUrls.length) {
        setStatus($("uploadStatus"), "No photos uploaded yet.", "");
        return;
      }

      setStatus($("uploadStatus"), `Photos: ${uploadedImageUrls.length}`, "ok");

      // If preview is hidden, don't render thumbs (optional)
      if (!previewOn) return;

      uploadedImageUrls.forEach((url, idx) => {
        const wrap = document.createElement("div");
        wrap.className = "thumb";

        const img = document.createElement("img");
        img.src = url;
        img.alt = "House photo";

        const btn = document.createElement("button");
        btn.className = "secondary";
        btn.type = "button";
        btn.textContent = "Remove";
        btn.addEventListener("click", () => {
          uploadedImageUrls.splice(idx, 1);
          renderGallery();
        });

        wrap.appendChild(img);
        wrap.appendChild(btn);
        g.appendChild(wrap);
      });
    }

    function syncPreviewUI() {
      $("gallery").style.display = previewOn ? "flex" : "none";
      $("btnPreviewPhotos").textContent = previewOn ? "Hide Preview" : "Preview Photos";
      $("previewHint").textContent = previewOn ? "Preview is visible" : "Preview is hidden";
    }

    // ---------------- Uploads ----------------
    async function uploadHousePhotos(fileList) {
      const files = Array.from(fileList || []);
      if (!files.length) return;

      // allow re-selecting same files later
      $("images").value = "";

      setStatus($("uploadStatus"), `Uploading ${files.length} photo(s)...`, "");

      try {
        const fd = new FormData();

        // MUST match server: upload.array("images", 12)
        for (const f of files) fd.append("images", f);

        const r = await fetch("/api/uploads", { method: "POST", body: fd });
        const data = await r.json().catch(() => ({}));

        if (!r.ok || !data.ok) throw new Error(data.error || "Upload failed.");

        uploadedImageUrls = uploadedImageUrls.concat(data.imageUrls || []);
        setStatus($("uploadStatus"), `Uploaded ${data.imageUrls?.length || 0}. Total: ${uploadedImageUrls.length}`, "ok");
        renderGallery();
      } catch (e) {
        setStatus($("uploadStatus"), String(e?.message || e), "error");
      }
    }

    async function uploadAgentLogo(file) {
      if (!file) return;

      setStatus($("logoStatus"), "Uploading logo...", "");

      try {
        const fd = new FormData();

        // MUST match server: upload.single("image")
        fd.append("image", file);

        const r = await fetch("/api/upload", { method: "POST", body: fd });
        const data = await r.json().catch(() => ({}));

        if (!r.ok || !data.ok) throw new Error(data.error || "Logo upload failed.");

        uploadedLogoUrl = data.imageUrl;
        setStatus($("logoStatus"), "Logo uploaded ✓", "ok");
      } catch (e) {
        setStatus($("logoStatus"), String(e?.message || e), "error");
      }
    }

    // ---------------- Listing generate/save/pdf ----------------
    function collectInput() {
      return {
        tone: $("tone").value,
        address: $("address").value.trim(),
        city: $("city").value.trim(),
        state: $("state").value.trim(),
        price: $("price").value.trim(),
        beds: $("beds").value.trim(),
        baths: $("baths").value.trim(),
        sqft: $("sqft").value.trim(),
        yearBuilt: $("yearBuilt").value.trim(),
        features: $("features").value.trim(),
        descriptionInput: $("descriptionInput").value.trim(),

        // multi images
        imageUrls: uploadedImageUrls,
        // back-compat main image
        imageUrl: uploadedImageUrls[0] || "",

        agent: {
          name: $("agentName").value.trim(),
          brokerage: $("agentBrokerage").value.trim(),
          phone: $("agentPhone").value.trim(),
          email: $("agentEmail").value.trim(),
          logoUrl: uploadedLogoUrl || ""
        }
      };
    }

    function renderResult(listing) {
      $("resultTitle").textContent = listing.title || "Property Listing";
      $("resultDesc").textContent = listing.description || "";

      const meta = [];
      if (listing.tone) meta.push(listing.tone);
      const addr = [listing.address, listing.city, listing.state].filter(Boolean).join(", ");
      if (addr) meta.push(addr);
      if (listing.price) meta.push(listing.price);

      $("resultMeta").innerHTML = meta.map(x => `<span class="pill">${esc(x)}</span>`).join("");

      if (listing.id) {
        const shareUrl = `${location.origin}/listing/${encodeURIComponent(listing.id)}`;
        $("shareBox").innerHTML = `Share link: <a class="link" href="${shareUrl}" target="_blank" rel="noreferrer">${shareUrl}</a>`;
      } else {
        $("shareBox").textContent = "";
      }

      $("btnSave").disabled = false;
      $("btnPdf").disabled = false;
    }

    async function generateListing() {
      $("btnGenerate").disabled = true;
      setStatus($("mainStatus"), "Generating...", "");

      try {
        const input = collectInput();

        const r = await fetch("/api/listings/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(input)
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok || !data.ok) throw new Error(data.error || "Generate failed.");

        currentListing = data.listing;
        renderResult(currentListing);
        setStatus($("mainStatus"), "Generated ✓", "ok");
      } catch (e) {
        setStatus($("mainStatus"), String(e?.message || e), "error");
      } finally {
        $("btnGenerate").disabled = false;
      }
    }

    async function saveListing() {
      if (!currentListing?.id) return;

      $("btnSave").disabled = true;
      setStatus($("mainStatus"), "Saving...", "");

      try {
        const r = await fetch("/api/listings/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(currentListing)
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok || !data.ok) throw new Error(data.error || "Save failed.");

        setStatus($("mainStatus"), "Saved ✓", "ok");
      } catch (e) {
        setStatus($("mainStatus"), String(e?.message || e), "error");
      } finally {
        $("btnSave").disabled = false;
      }
    }

    async function downloadPdf() {
      if (!currentListing) return;

      $("btnPdf").disabled = true;
      setStatus($("mainStatus"), "Building PDF...", "");

      try {
        const r = await fetch("/api/pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(currentListing)
        });

        if (!r.ok) {
          const txt = await r.text();
          throw new Error(txt || "PDF failed.");
        }

        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "listing.pdf";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        setStatus($("mainStatus"), "PDF downloaded ✓", "ok");
      } catch (e) {
        setStatus($("mainStatus"), String(e?.message || e), "error");
      } finally {
        $("btnPdf").disabled = false;
      }
    }

    // ---------------- Wire up DOM ----------------
   document.addEventListener("DOMContentLoaded", () => {
  console.log("✅ DOM loaded");

  const btnGen = document.getElementById("btnGenerate");
  const btnSave = document.getElementById("btnSave");
  const btnPdf = document.getElementById("btnPdf");

  if (!btnGen) {
    alert("❌ btnGenerate not found. Wrong HTML loaded or id mismatch.");
    return;
  }

  btnGen.onclick = async () => {
    console.log("✅ Generate clicked (handler running)");
    await generateListing();
  };

  btnSave.onclick = async () => {
    console.log("✅ Save clicked");
    await saveListing();
  };

  btnPdf.onclick = async () => {
    console.log("✅ PDF clicked");
    await downloadPdf();
  };
});

      // toggle preview
      $("btnPreviewPhotos").addEventListener("click", () => {
        previewOn = !previewOn;
        syncPreviewUI();
        renderGallery();
      });

      // multi photos
      $("images").addEventListener("change", (e) => uploadHousePhotos(e.target.files));

      // logo
      $("agentLogo").addEventListener("change", (e) => uploadAgentLogo(e.target.files?.[0]));

      // actions
      $("btnGenerate").addEventListener("click", generateListing);
      $("btnSave").addEventListener("click", saveListing);
      $("btnPdf").addEventListener("click", downloadPdf);
    });
  </script>
</body>
</html>
